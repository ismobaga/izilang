name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  build-and-test:
    name: Build and Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        config: [Debug, Release]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install premake5 (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        wget https://github.com/premake/premake-core/releases/download/v5.0.0-beta2/premake-5.0.0-beta2-linux.tar.gz
        tar -xzf premake-5.0.0-beta2-linux.tar.gz
        sudo mv premake5 /usr/local/bin/
        premake5 --version

    - name: Install premake5 (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install premake

    - name: Install premake5 (Windows)
      if: runner.os == 'Windows'
      run: |
        curl -L https://github.com/premake/premake-core/releases/download/v5.0.0-beta2/premake-5.0.0-beta2-windows.zip -o premake5.zip
        Expand-Archive premake5.zip -DestinationPath premake5-bin
        echo "${{ github.workspace }}\premake5-bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Generate build files
      run: premake5 gmake2

    - name: Build project (Unix)
      if: runner.os != 'Windows'
      run: make config=${{ matrix.config == 'Debug' && 'debug' || 'release' }} -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)

    - name: Build project (Windows)
      if: runner.os == 'Windows'
      run: |
        premake5 vs2022
        msbuild IziLang.sln /p:Configuration=${{ matrix.config }} /m

    - name: Run tests (Unix)
      if: runner.os != 'Windows'
      run: ./bin/${{ matrix.config }}/tests/tests

    - name: Run tests (Windows)
      if: runner.os == 'Windows'
      run: .\bin\${{ matrix.config }}\tests\tests.exe

    - name: Upload artifacts
      if: matrix.config == 'Release'
      uses: actions/upload-artifact@v4
      with:
        name: izilang-${{ runner.os }}-${{ matrix.config }}
        path: |
          bin/${{ matrix.config }}/izi/izi*
          bin/${{ matrix.config }}/tests/tests*
